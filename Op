local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

local player = Players.LocalPlayer
local savedPosition = nil

-- Walk speed controls
local speedValue = 16
local maxSpeed = 120
local minSpeed = 16

-- Fly controls
local flying = false
local flySpeed = 20
local flyMax = 30
local flyMin = 1

-- Noclip
local noclipEnabled = false

-- Input state for fly movement
local keys = {W=false, A=false, S=false, D=false, Space=false, Shift=false}

-- Utility
local function clamp(v, a, b) return math.clamp(v, a, b) end

-- Create UI
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "RGBTeleportGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 320, 0, 240)
    frame.Position = UDim2.new(0.5, -160, 0.5, -120)
    frame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    frame.Active = true

    -- Custom drag (Draggable is deprecated)
    local dragging = false
    local dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- Title and minimize/restore
    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, -40, 0, 30)
    title.Position = UDim2.new(0, 10, 0, 5)
    title.BackgroundTransparency = 1
    title.Text = "RGB Teleport & Ferramentas"
    title.Font = Enum.Font.Nunito
    title.TextSize = 18
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextColor3 = Color3.new(1,1,1)

    local minimizeBtn = Instance.new("TextButton", frame)
    minimizeBtn.Size = UDim2.new(0, 30, 0, 30)
    minimizeBtn.Position = UDim2.new(1, -35, 0, 5)
    minimizeBtn.Text = "-"
    minimizeBtn.Font = Enum.Font.Nunito
    minimizeBtn.TextSize = 20
    minimizeBtn.BackgroundTransparency = 0.25

    local restoreBtn = Instance.new("TextButton", screenGui)
    restoreBtn.Size = UDim2.new(0, 140, 0, 30)
    restoreBtn.Position = UDim2.new(0.5, -70, 0.5, -140)
    restoreBtn.Text = "Restaurar Painel"
    restoreBtn.Font = Enum.Font.Nunito
    restoreBtn.TextSize = 16
    restoreBtn.BackgroundTransparency = 0.25
    restoreBtn.Visible = false

    minimizeBtn.MouseButton1Click:Connect(function()
        frame.Visible = false
        restoreBtn.Visible = true
    end)
    restoreBtn.MouseButton1Click:Connect(function()
        frame.Visible = true
        restoreBtn.Visible = false
    end)

    -- Save and Teleport buttons
    local saveBtn = Instance.new("TextButton", frame)
    saveBtn.Size = UDim2.new(0, 260, 0, 36)
    saveBtn.Position = UDim2.new(0, 30, 0, 40)
    saveBtn.Text = "Salvar Posição"
    saveBtn.Font = Enum.Font.Nunito
    saveBtn.TextSize = 18
    saveBtn.BackgroundTransparency = 0.15

    local tpBtn = Instance.new("TextButton", frame)
    tpBtn.Size = UDim2.new(0, 260, 0, 36)
    tpBtn.Position = UDim2.new(0, 30, 0, 86)
    tpBtn.Text = "Teleportar"
    tpBtn.Font = Enum.Font.Nunito
    tpBtn.TextSize = 18
    tpBtn.BackgroundTransparency = 0.15

    -- Walk speed controls
    local speedMinusBtn = Instance.new("TextButton", frame)
    speedMinusBtn.Size = UDim2.new(0, 30, 0, 30)
    speedMinusBtn.Position = UDim2.new(0, 30, 0, 132)
    speedMinusBtn.Text = "-"
    speedMinusBtn.Font = Enum.Font.Nunito
    speedMinusBtn.TextSize = 20
    speedMinusBtn.BackgroundTransparency = 0.15

    local speedLabel = Instance.new("TextLabel", frame)
    speedLabel.Size = UDim2.new(0, 200, 0, 30)
    speedLabel.Position = UDim2.new(0, 68, 0, 132)
    speedLabel.Text = "Velocidade: " .. tostring(speedValue)
    speedLabel.Font = Enum.Font.Nunito
    speedLabel.TextSize = 16
    speedLabel.BackgroundTransparency = 1

    local speedPlusBtn = Instance.new("TextButton", frame)
    speedPlusBtn.Size = UDim2.new(0, 30, 0, 30)
    speedPlusBtn.Position = UDim2.new(1, -60, 0, 132)
    speedPlusBtn.Text = "+"
    speedPlusBtn.Font = Enum.Font.Nunito
    speedPlusBtn.TextSize = 20
    speedPlusBtn.BackgroundTransparency = 0.15

    -- Fly controls
    local flyToggleBtn = Instance.new("TextButton", frame)
    flyToggleBtn.Size = UDim2.new(0, 120, 0, 28)
    flyToggleBtn.Position = UDim2.new(0, 30, 0, 172)
    flyToggleBtn.Text = "Fly: OFF"
    flyToggleBtn.Font = Enum.Font.Nunito
    flyToggleBtn.TextSize = 16
    flyToggleBtn.BackgroundTransparency = 0.15

    local flyMinusBtn = Instance.new("TextButton", frame)
    flyMinusBtn.Size = UDim2.new(0, 30, 0, 28)
    flyMinusBtn.Position = UDim2.new(0, 170, 0, 172)
    flyMinusBtn.Text = "-"
    flyMinusBtn.Font = Enum.Font.Nunito
    flyMinusBtn.TextSize = 18
    flyMinusBtn.BackgroundTransparency = 0.15

    local flyLabel = Instance.new("TextLabel", frame)
    flyLabel.Size = UDim2.new(0, 80, 0, 28)
    flyLabel.Position = UDim2.new(0, 206, 0, 172)
    flyLabel.Text = "Vel Fly: " .. tostring(flySpeed)
    flyLabel.Font = Enum.Font.Nunito
    flyLabel.TextSize = 16
    flyLabel.BackgroundTransparency = 1

    local flyPlusBtn = Instance.new("TextButton", frame)
    flyPlusBtn.Size = UDim2.new(0, 30, 0, 28)
    flyPlusBtn.Position = UDim2.new(1, -30, 0, 172)
    flyPlusBtn.Text = "+"
    flyPlusBtn.Font = Enum.Font.Nunito
    flyPlusBtn.TextSize = 18
    flyPlusBtn.BackgroundTransparency = 0.15

    -- Noclip toggle
    local noclipBtn = Instance.new("TextButton", frame)
    noclipBtn.Size = UDim2.new(0, 120, 0, 28)
    noclipBtn.Position = UDim2.new(0, 170, 0, 40)
    noclipBtn.Text = "Noclip: OFF"
    noclipBtn.Font = Enum.Font.Nunito
    noclipBtn.TextSize = 16
    noclipBtn.BackgroundTransparency = 0.15

    -- RGB background
    local hue = 0
    RunService.RenderStepped:Connect(function()
        hue = (hue + 0.008) % 1
        local color = Color3.fromHSV(hue, 1, 1)
        if frame.Visible then
            frame.BackgroundColor3 = color
            saveBtn.BackgroundColor3 = color
            tpBtn.BackgroundColor3 = color
            minimizeBtn.BackgroundColor3 = color
            flyToggleBtn.BackgroundColor3 = color
            flyMinusBtn.BackgroundColor3 = color
            flyPlusBtn.BackgroundColor3 = color
            noclipBtn.BackgroundColor3 = color
            speedMinusBtn.BackgroundColor3 = color
            speedPlusBtn.BackgroundColor3 = color
        end
        restoreBtn.BackgroundColor3 = color
    end)

    -- Save position
    saveBtn.MouseButton1Click:Connect(function()
        local char = player.Character or player.CharacterAdded:Wait()
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            savedPosition = hrp.Position
            saveBtn.Text = "Posição Salva!"
            wait(1)
            saveBtn.Text = "Salvar Posição"
        end
    end)

    tpBtn.MouseButton1Click:Connect(function()
        if savedPosition then
            local char = player.Character or player.CharacterAdded:Wait()
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                hrp.CFrame = CFrame.new(savedPosition)
                tpBtn.Text = "Teleportado!"
                wait(1)
                tpBtn.Text = "Teleportar"
            end
        else
            tpBtn.Text = "Nenhuma posição!"
            wait(1)
            tpBtn.Text = "Teleportar"
        end
    end)

    -- Walk speed functions
    local function setSpeed(newSpeed)
        speedValue = clamp(newSpeed, minSpeed, maxSpeed)
        speedLabel.Text = "Velocidade: " .. tostring(speedValue)
        local char = player.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum.WalkSpeed = speedValue end
        end
    end

    speedPlusBtn.MouseButton1Click:Connect(function() setSpeed(speedValue + 2) end)
    speedMinusBtn.MouseButton1Click:Connect(function() setSpeed(speedValue - 2) end)

    -- Fly functions
    local flyBV, flyBG, flyConn
    local function setFlySpeed(v)
        flySpeed = clamp(v, flyMin, flyMax)
        flyLabel.Text = "Vel Fly: " .. tostring(flySpeed)
    end
    flyPlusBtn.MouseButton1Click:Connect(function() setFlySpeed(flySpeed + 1) end)
    flyMinusBtn.MouseButton1Click:Connect(function() setFlySpeed(flySpeed - 1) end)

    local function startFly()
        local char = player.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        local hum = char:FindFirstChildOfClass("Humanoid")
        if not hrp or not hum then return end

        if flying then return end
        flying = true
        flyToggleBtn.Text = "Fly: ON"
        hum.PlatformStand = true

        flyBG = Instance.new("BodyGyro")
        flyBG.P = 9e4
        flyBG.MaxTorque = Vector3.new(9e9,9e9,9e9)
        flyBG.CFrame = hrp.CFrame
        flyBG.Parent = hrp

        flyBV = Instance.new("BodyVelocity")
        flyBV.MaxForce = Vector3.new(9e9,9e9,9e9)
        flyBV.Velocity = Vector3.new(0,0,0)
        flyBV.Parent = hrp

        -- Heartbeat loop for smooth physics-based flight
        flyConn = RunService.Heartbeat:Connect(function()
            if not flying or not hrp then return end

            local camCFrame = Camera.CFrame
            local forward = Vector3.new(camCFrame.LookVector.X, 0, camCFrame.LookVector.Z)
            if forward.Magnitude == 0 then forward = Vector3.new(0,0,-1) end
            forward = forward.Unit
            local right = Vector3.new(camCFrame.RightVector.X, 0, camCFrame.RightVector.Z)
            if right.Magnitude == 0 then right = Vector3.new(1,0,0) end
            right = right.Unit

            local moveDir = Vector3.new(0,0,0)
            if keys.W then moveDir = moveDir + forward end
            if keys.S then moveDir = moveDir - forward end
            if keys.D then moveDir = moveDir + right end
            if keys.A then moveDir = moveDir - right end
            if keys.Space then moveDir = moveDir + Vector3.new(0,1,0) end
            if keys.Shift then moveDir = moveDir + Vector3.new(0,-1,0) end

            if moveDir.Magnitude > 0 then
                local velocity = moveDir.Unit * flySpeed
                -- preserve small vertical control smoothing
                flyBV.Velocity = velocity
                flyBG.CFrame = CFrame.new(hrp.Position, hrp.Position + Camera.CFrame.LookVector)
            else
                flyBV.Velocity = Vector3.new(0,0,0)
                flyBG.CFrame = CFrame.new(hrp.Position, hrp.Position + Camera.CFrame.LookVector)
            end
        end)
    end

    local function stopFly()
        if not flying then return end
        flying = false
        flyToggleBtn.Text = "Fly: OFF"
        local char = player.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum.PlatformStand = false end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                if flyBG then flyBG:Destroy(); flyBG = nil end
                if flyBV then flyBV:Destroy(); flyBV = nil end
            end
        end
        if flyConn then flyConn:Disconnect(); flyConn = nil end
    end

    flyToggleBtn.MouseButton1Click:Connect(function()
        if not flying then startFly() else stopFly() end
    end)

    -- Noclip functions
    local function setNoclip(enabled)
        noclipEnabled = enabled
        noclipBtn.Text = "Noclip: " .. (enabled and "ON" or "OFF")
    end
    noclipBtn.MouseButton1Click:Connect(function()
        setNoclip(not noclipEnabled)
    end)

    -- Keyboard input for fly
    -- Use GetFocusedTextBox to avoid interfering with typing in UI
    UserInputService.InputBegan:Connect(function(input, processed)
        if UserInputService:GetFocusedTextBox() then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.W then keys.W = true end
            if input.KeyCode == Enum.KeyCode.S then keys.S = true end
            if input.KeyCode == Enum.KeyCode.A then keys.A = true end
            if input.KeyCode == Enum.KeyCode.D then keys.D = true end
            if input.KeyCode == Enum.KeyCode.Space then keys.Space = true end
            if input.KeyCode == Enum.KeyCode.LeftShift or input.KeyCode == Enum.KeyCode.RightShift then keys.Shift = true end
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.W then keys.W = false end
            if input.KeyCode == Enum.KeyCode.S then keys.S = false end
            if input.KeyCode == Enum.KeyCode.A then keys.A = false end
            if input.KeyCode == Enum.KeyCode.D then keys.D = false end
            if input.KeyCode == Enum.KeyCode.Space then keys.Space = false end
            if input.KeyCode == Enum.KeyCode.LeftShift or input.KeyCode == Enum.KeyCode.RightShift then keys.Shift = false end
        end
    end)

    -- Keep walk speed consistent on respawn and restart fly if needed
    local function onCharacterAdded(char)
        local hum = char:WaitForChild("Humanoid")
        hum.WalkSpeed = speedValue
        if flying then
            wait(0.2)
            stopFly()
            startFly()
        end
    end
    player.CharacterAdded:Connect(onCharacterAdded)

    -- Apply initial speed if character already exists
    local function applyInitial()
        local char = player.Character
        if char then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum.WalkSpeed = speedValue end
        end
    end
    applyInitial()

    -- Noclip and fly runtime behavior
    RunService.Heartbeat:Connect(function()
        local char = player.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        -- Noclip: disable collisions for character parts to allow passing through walls.
        -- Attempt to avoid letting the player fall through floors by nudging above detected floor surfaces.
        if noclipEnabled then
            for _, part in pairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end

            -- Raycast downward to detect floor-like surfaces below the player.
            local origin = hrp.Position
            local rayParams = RaycastParams.new()
            rayParams.FilterDescendantsInstances = {char}
            rayParams.FilterType = Enum.RaycastFilterType.Blacklist
            rayParams.IgnoreWater = true
            local ray = workspace:Raycast(origin, Vector3.new(0, -1, 0) * 6, rayParams)
            if ray and ray.Instance and ray.Normal and ray.Normal.Y >= 0.7 then
                local surfaceY = ray.Position.Y
                local distance = origin.Y - surfaceY
                if distance < 2 then
                    hrp.CFrame = CFrame.new(Vector3.new(hrp.Position.X, surfaceY + 3, hrp.Position.Z))
                end
            end
        else
            -- Restore collisions when noclip is off
            for _, part in pairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end
    end)
end

createUI()
